<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inadimpl√™ncia</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SheetJS para ler XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card-header { background-color: #007bff; color: white; font-weight: bold; }
        table { width: 100%; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .hidden { display: none; }
        #loadingIndicator { text-align: center; padding: 20px; }
        #errorMessage { color: red; margin-top: 10px; }
        #datePickerContainer { margin-bottom: 15px; }
        #yearCheckboxes { margin-bottom: 15px; }
        
        /* Estilos melhorados para Resumo Geral */
        .resumo-card { 
            background: linear-gradient(135deg, #e9f5f8 0%, #d4edda 100%); 
            border-left: 5px solid #28a745; 
        }
        .resumo-card .card-header { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            font-size: 1.2rem;
        }
        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .resumo-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .resumo-empresa-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #ffc107;
        }
        .resumo-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            margin: 5px 0;
        }
        .resumo-empresa-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffc107;
            margin: 5px 0;
        }
        .resumo-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0;
        }
        .resumo-empresa-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin: 0;
            font-weight: bold;
        }
        
        /* Estilos para subcards */
        .subcard-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            margin-top: 15px;
        }
        .subcard { 
            flex: 1 1 300px; 
            min-width: 0; 
            border: 1px solid #dee2e6; 
            border-radius: 0.375rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .subcard-header { 
            background-color: #f8f9fa; 
            padding: 10px 15px; 
            border-bottom: 1px solid #dee2e6; 
            font-weight: bold;
        }
        .subcard-body { 
            padding: 15px; 
            max-height: 400px; 
            overflow-y: auto;
        }
        .subcard-table { 
            width: 100%; 
            font-size: 0.875rem;
        }
        .subcard-table th, 
        .subcard-table td { 
            padding: 6px 8px; 
            text-align: left; 
            border-bottom: 1px solid #dee2e6; 
        }
        .subcard-table th { 
            background-color: #f1f3f4; 
            position: sticky; 
            top: 0; 
        }
        
        /* Estilos para o PDF */
        @media print {
            .subcard-container { 
                display: block; 
            }
            .subcard { 
                break-inside: avoid; 
                margin-bottom: 15px;
            }
        }
        
        /* Estilo para t√≠tulo din√¢mico */
        .dashboard-title {
            transition: all 0.3s ease;
        }
        .company-name {
            color: #007bff;
            font-weight: bold;
        }
        .years-range {
            color: #28a745;
            font-weight: bold;
        }
        
        /* Estilo para o combobox de empresas */
        .company-selector {
            margin-bottom: 15px;
        }
        
        /* Estilo para bot√£o de limpar filtros */
        .btn-clear {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        .btn-clear:hover {
            background-color: #c82333;
            border-color: #bd2130;
            color: white;
        }
        
        /* Estilos para a caixa de pesquisa de clientes */
        .client-search-container {
            position: relative;
        }
        .client-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .client-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .client-search-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
        }
        .client-search-item:hover {
            background-color: #f8f9fa;
        }
        .client-search-item.selected {
            background-color: #e7f3ff;
        }
        .client-search-checkbox {
            margin-right: 8px;
        }
        .client-search-select-all {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .selected-clients-container {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            background-color: #f8f9fa;
        }
        .selected-client-tag {
            display: inline-flex;
            align-items: center;
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 16px;
            margin: 2px 4px 2px 0;
            font-size: 12px;
        }
        .selected-client-tag button {
            background: none;
            border: none;
            color: white;
            margin-left: 4px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        .client-search-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .client-search-label {
            margin-bottom: 0;
            flex: 1;
        }
        .clear-selection-btn {
            white-space: nowrap;
        }
        
        /* Estilos para totais nas tabelas */
        .table-total {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .empresa-total {
            font-weight: bold;
            background-color: #fff3cd;
        }
        
        /* Novos estilos para o modal de hist√≥rico do cliente */
        .modal-cliente-historico .modal-dialog {
            max-width: 90%;
        }
        .modal-cliente-historico .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .historico-timeline {
            position: relative;
            padding-left: 30px;
        }
        .historico-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #007bff;
        }
        .historico-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .historico-ano-header {
            color: #007bff;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .historico-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .historico-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .historico-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #dc3545;
        }
        .historico-stat-label {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .historico-titulos-table {
            font-size: 0.85rem;
        }
        .historico-titulos-table th {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .btn-ver-historico {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-ver-historico:hover {
            color: #0056b3;
        }
        .client-name-clickable {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }
        .client-name-clickable:hover {
            color: #0056b3;
            font-weight: bold;
        }
        /* Novo estilo para destacar Importar Planilha */
        .import-label {
            font-weight: bold;
            color: #007bff;
        }
        .form-control[type="file"] {
            border: 2px solid #007bff;
            background-color: #e9f5f8;
        }
        /* Estilos para meses */
        .months-container {
            margin-left: 20px;
            display: none;
        }
        .months-container.visible {
            display: block;
        }
        .insights-global .resumo-value {
            white-space: pre-wrap;
            font-size: 1.2rem;
            text-align: left;
        }
        /* Novo estilo para filtros em cards */
        .filter-card {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .year-filter-card {
            margin: 10px 0;
        }
        /* Estilos para insights lineares */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }
        .insight-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
        }
        .insight-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #28a745;
        }
        /* Lado a lado para filtros */
        #yearCheckboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <!-- T√≠tulo din√¢mico que ser√° atualizado -->
        <h1 class="text-center mb-4 dashboard-title" id="dashboardTitle">
            Dashboard de Inadimpl√™ncia - <span class="company-name">Selecione uma empresa</span> - <span class="years-range">Selecione os anos</span>
        </h1>
        
        <!-- Se√ß√£o de Upload e Data Limite -->
        <div class="card">
            <div class="card-header">Importar Planilha e Definir Filtros</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="dateLimit">Data Limite de Vencimento: </label>
                        <input type="date" id="dateLimit" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label for="fileInput" class="import-label">Importar Planilha: </label>
                        <input type="file" id="fileInput" accept=".xlsx" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="companySelect">Empresa Emissora: </label>
                        <select id="companySelect" class="form-select hidden">
                            <option value="">Carregando empresas...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Se√ß√£o melhorada para pesquisa de clientes -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="client-search-header">
                            <label for="clientSearch" class="client-search-label">üîç Pesquisar Clientes (busca inteligente):</label>
                            <button id="clearClientSelection" class="btn btn-sm btn-outline-secondary clear-selection-btn">Limpar Sele√ß√£o</button>
                        </div>
                        <div class="client-search-container">
                            <input type="text" id="clientSearch" class="client-search-input form-control" placeholder="Digite para buscar clientes... (suporte a busca parcial)">
                            <div id="clientSearchResults" class="client-search-results hidden">
                                <!-- Checkbox "Selecionar Todos" ser√° inserido aqui -->
                            </div>
                        </div>
                        <div id="selectedClientsContainer" class="selected-clients-container hidden">
                            <!-- Tags de clientes selecionados ser√£o inseridas aqui -->
                        </div>
                    </div>
                </div>
                
                <div id="yearCheckboxes" class="mb-3 hidden">
                    <label>Anos a Incluir na Pesquisa:</label><br>
                    <!-- Checkboxes gerados dinamicamente -->
                </div>
                <div class="d-flex gap-2">
                    <button id="analyzeBtn" class="btn btn-primary" disabled>Iniciar An√°lise</button>
                    <button id="clearFiltersBtn" class="btn btn-clear" disabled>Limpar Filtros</button>
                </div>
                <div id="errorMessage" class="hidden"></div>
            </div>
        </div>
        
        <!-- Indicador de Carregamento -->
        <div id="loadingIndicator" class="hidden">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Processando dados...</p>
        </div>
        
        <!-- Dashboard (inicialmente oculto) -->
        <div id="dashboard" class="hidden">
            <!-- Card Resumo Geral - MELHORADO -->
            <div class="card resumo-card">
                <div class="card-header">üìå Resumo Geral</div>
                <div class="card-body">
                    <div id="resumoGrid" class="resumo-grid">
                        <!-- Itens ser√£o adicionados via JS -->
                    </div>
                    <!-- Se√ß√£o de empresas envolvidas -->
                    <div id="empresasSection" class="mt-4 hidden">
                        <h6 class="mb-3">üìä Distribui√ß√£o por Empresa Emissora</h6>
                        <div id="empresasGrid" class="resumo-grid">
                            <!-- Cards de empresas ser√£o adicionados via JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Card 1: Volume por Cliente - MELHORADO com hist√≥rico -->
            <div class="card">
                <div class="card-header">üìä Volume de T√≠tulos por Cliente 
                    <small class="text-light">(Clique no nome do cliente para ver hist√≥rico detalhado)</small>
                </div>
                <div class="card-body">
                    <table id="tableCliente">
                        <thead><tr><th>Cliente</th><th>Contagem de T√≠tulos</th><th>Soma de Valores (R$)</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Card 2: Volume por M√™s (Pivot Horizontal) - MELHORADO -->
            <div class="card">
                <div class="card-header">üìÖ Volume de T√≠tulos por M√™s de Vencimento</div>
                <div class="card-body">
                    <div id="mesSubcards" class="subcard-container">
                        <!-- Subcards ser√£o gerados dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Card 3: Volume por Vendedor (Incluindo Sem Vendedor) -->
            <div class="card">
                <div class="card-header">üë• Volume de T√≠tulos por Vendedor</div>
                <div class="card-body">
                    <table id="tableVendedor">
                        <thead><tr><th>Vendedor</th><th>Contagem de T√≠tulos</th><th>Soma de Valores (R$)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Card 4: Volume por Cliente e Vendedor - ATUALIZADO com totais por empresa -->
            <div class="card">
                <div class="card-header">üîó Volume de T√≠tulos por Cliente e Vendedor</div>
                <div class="card-body">
                    <table id="tableClienteVendedor">
                        <thead><tr><th>Cliente</th><th>Vendedor</th><th>Contagem de T√≠tulos</th><th>Soma de Valores (R$)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Card 5: Distribui√ß√£o por Vendedor e M√™s (Incluindo Sem Vendedor) - MELHORADO -->
            <div class="card">
                <div class="card-header">üìä Distribui√ß√£o Cruzada - Valores por Vendedor e M√™s</div>
                <div class="card-body">
                    <div id="vendedorMesSubcards" class="subcard-container">
                        <!-- Subcards ser√£o gerados dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Card 6: T√≠tulos com Vencimento Futuro - MELHORADO -->
            <div class="card">
                <div class="card-header">‚è≥ T√≠tulos com Vencimento Futuro</div>
                <div class="card-body">
                    <div id="futureSubcards" class="subcard-container">
                        <!-- Subcards ser√£o gerados dinamicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes para Gerar e Visualizar PDF -->
            <div class="d-flex gap-2 mt-3">
                <button id="generatePdfBtn" class="btn btn-success">Gerar PDF</button>
                <button id="viewPdfBtn" class="btn btn-info">Visualizar PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal de Hist√≥rico do Cliente -->
    <div class="modal fade modal-cliente-historico" id="modalHistoricoCliente" tabindex="-1" aria-labelledby="modalHistoricoClienteLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalHistoricoClienteLabel">
                        üìä Hist√≥rico de Inadimpl√™ncia - <span id="modalClienteNome">Cliente</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>üìÖ Per√≠odo de An√°lise:</h6>
                            <div id="modalPeriodoInfo" class="text-muted">
                                <!-- Per√≠odo ser√° preenchido dinamicamente -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>üí∞ Resumo Geral do Cliente:</h6>
                            <div id="modalResumoGeral">
                                <!-- Resumo ser√° preenchido dinamicamente -->
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div id="modalHistoricoContent" class="historico-timeline">
                        <!-- Conte√∫do do hist√≥rico ser√° inserido aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- NOVO: Bot√£o para visualizar PDF antes de baixar -->
                    <button type="button" id="btnVisualizarPdfCliente" class="btn btn-info me-2">
                        üëÅÔ∏è Visualizar PDF
                    </button>
                    <button type="button" id="btnGerarPdfCliente" class="btn btn-success me-2">
                        üìÑ Gerar PDF do Cliente
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // RESTAURA√á√ÉO DO C√ìDIGO ORIGINAL COMPLETO
        const fileInput = document.getElementById('fileInput');
        const dateLimit = document.getElementById('dateLimit');
        const yearCheckboxesContainer = document.getElementById('yearCheckboxes');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('errorMessage');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const viewPdfBtn = document.getElementById('viewPdfBtn');
        const vendedorMesSubcards = document.getElementById('vendedorMesSubcards');
        const futureSubcards = document.getElementById('futureSubcards');
        const mesSubcards = document.getElementById('mesSubcards');
        const resumoGrid = document.getElementById('resumoGrid');
        const dashboardTitle = document.getElementById('dashboardTitle');
        const companySelect = document.getElementById('companySelect');
        
        // Elementos da funcionalidade de pesquisa de clientes
        const clientSearch = document.getElementById('clientSearch');
        const clientSearchResults = document.getElementById('clientSearchResults');
        const selectedClientsContainer = document.getElementById('selectedClientsContainer');
        const clearClientSelectionBtn = document.getElementById('clearClientSelection');
        
        // Elementos do modal de hist√≥rico
        const modalHistoricoCliente = new bootstrap.Modal(document.getElementById('modalHistoricoCliente'));
        const modalClienteNome = document.getElementById('modalClienteNome');
        const modalPeriodoInfo = document.getElementById('modalPeriodoInfo');
        const modalResumoGeral = document.getElementById('modalResumoGeral');
        const modalHistoricoContent = document.getElementById('modalHistoricoContent');
        const btnGerarPdfCliente = document.getElementById('btnGerarPdfCliente');
        const btnVisualizarPdfCliente = document.getElementById('btnVisualizarPdfCliente'); // NOVO
        
        let data = []; // Armazenar dados processados
        let originalData = []; // Dados originais da planilha para hist√≥rico
        let selectedCompany = ''; // Empresa selecionada pelo usu√°rio
        let selectedYears = []; // Anos selecionados pelo usu√°rio
        let selectedMonths = new Map(); // Mapa de anos para Sets de meses selecionados (1-12)
        let availableCompanies = new Set(); // Empresas dispon√≠veis na planilha
        let availableMonths = new Map(); // Mapa de anos para Sets de meses dispon√≠veis
        let allClients = new Set(); // Todos os clientes dispon√≠veis
        let selectedClients = new Set(); // Clientes selecionados pelo usu√°rio
        let filteredClients = []; // Clientes filtrados para exibi√ß√£o
        let searchTimeout = null; // Timeout para pesquisa
        let clienteHistoricoAtual = ''; // Cliente atual no modal

        // Inicializar data atual como padr√£o para data limite
        const today = new Date();
        const todayFormatted = today.toISOString().slice(0, 10);
        dateLimit.value = todayFormatted;

        // Event listeners principais
        fileInput.addEventListener('change', () => {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
            if (fileInput.files.length > 0) {
                loadCompaniesAndYearsFromFile();
            } else {
                yearCheckboxesContainer.innerHTML = '';
                yearCheckboxesContainer.classList.add('hidden');
                companySelect.classList.add('hidden');
                analyzeBtn.disabled = true;
                clearFiltersBtn.disabled = true;
                updateDashboardTitle('', []);
            }
        });
        
        dateLimit.addEventListener('change', () => {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
            checkAnalyzeButton();
        });

        companySelect.addEventListener('change', () => {
            selectedCompany = companySelect.value;
            updateDashboardTitle(selectedCompany, selectedYears);
            checkAnalyzeButton();
        });

        clearFiltersBtn.addEventListener('click', clearAllFilters);
        analyzeBtn.addEventListener('click', startAnalysis);
        generatePdfBtn.addEventListener('click', () => generatePdf(true));
        viewPdfBtn.addEventListener('click', () => generatePdf(false));
        btnGerarPdfCliente.addEventListener('click', gerarPdfCliente);
        btnVisualizarPdfCliente.addEventListener('click', visualizarPdfCliente); // NOVO

        // Fun√ß√£o para atualizar o t√≠tulo do dashboard
        function updateDashboardTitle(company, years) {
            const companySpan = dashboardTitle.querySelector('.company-name');
            const yearsSpan = dashboardTitle.querySelector('.years-range');
            
            if (company) {
                companySpan.textContent = company;
            } else {
                companySpan.textContent = 'Selecione uma empresa';
            }
            
            if (years && years.length > 0) {
                years.sort((a, b) => a - b);
                if (years.length === 1) {
                    yearsSpan.textContent = years[0];
                } else {
                    const isConsecutive = years.every((year, index, array) => {
                        if (index === 0) return true;
                        return year === array[index - 1] + 1;
                    });
                    
                    if (isConsecutive) {
                        yearsSpan.textContent = `${years[0]} - ${years[years.length - 1]}`;
                    } else {
                        yearsSpan.textContent = years.join(', ');
                    }
                }
            } else {
                yearsSpan.textContent = 'Selecione os anos';
            }
        }

        // Fun√ß√£o para carregar empresas e anos da planilha
        function loadCompaniesAndYearsFromFile() {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const bytes = e.target.result;
                    const workbook = XLSX.read(bytes, { type: 'array' });
                    
                    if (!workbook.Sheets['Inadimpl√™ncia']) {
                        throw new Error('A aba "Inadimpl√™ncia" n√£o foi encontrada na planilha.');
                    }
                    
                    const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets['Inadimpl√™ncia'], { header: 1 }).slice(1);
                    originalData = sheetData; // Armazenar dados originais
                    
                    availableCompanies = new Set();
                    const yearsSet = new Set();
                    availableMonths = new Map();
                    allClients = new Set();

                    function serialToDate(serial) {
                        if (typeof serial !== 'number' || isNaN(serial)) return null;
                        return new Date((serial - 25569) * 86400 * 1000);
                    }

                    sheetData.forEach(row => {
                        if (row[7] && String(row[7]).trim() !== '') {
                            availableCompanies.add(String(row[7]).trim());
                        }
                        
                        const serial = row[1];
                        const vencimento = serialToDate(serial);
                        if (vencimento) {
                            const ano = vencimento.getFullYear();
                            const mes = vencimento.getMonth() + 1;
                            yearsSet.add(ano);
                            if (!availableMonths.has(ano)) {
                                availableMonths.set(ano, new Set());
                            }
                            availableMonths.get(ano).add(mes);
                        }
                        
                        if (row[0] && String(row[0]).trim() !== '') {
                            allClients.add(String(row[0]).trim());
                        }
                    });

                    // Popular combobox de empresas
                    companySelect.innerHTML = '';
                    if (availableCompanies.size > 0) {
                        const sortedCompanies = Array.from(availableCompanies).sort();
                        
                        const allOption = document.createElement('option');
                        allOption.value = '';
                        allOption.textContent = 'Todas as Empresas';
                        companySelect.appendChild(allOption);
                        
                        sortedCompanies.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company;
                            option.textContent = company;
                            companySelect.appendChild(option);
                        });
                        
                        companySelect.classList.remove('hidden');
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Nenhuma empresa encontrada na coluna H';
                        option.disabled = true;
                        companySelect.appendChild(option);
                        companySelect.classList.remove('hidden');
                    }

                    // Popular checkboxes de anos e meses em cards
                    yearCheckboxesContainer.innerHTML = '';
                    yearCheckboxesContainer.classList.remove('hidden');
                    const years = Array.from(yearsSet).sort();
                    years.forEach(year => {
                        const yearCard = document.createElement('div');
                        yearCard.className = 'filter-card year-filter-card';
                        const yearHeader = document.createElement('h6');
                        yearHeader.textContent = `Ano ${year}`;
                        yearCard.appendChild(yearHeader);
                        
                        const yearCheckboxDiv = document.createElement('div');
                        yearCheckboxDiv.className = 'form-check';
                        yearCheckboxDiv.innerHTML = `
                            <input class="form-check-input year-checkbox" type="checkbox" id="year${year}" value="${year}" checked>
                            <label class="form-check-label" for="year${year}">Incluir Ano ${year}</label>
                        `;
                        yearCard.appendChild(yearCheckboxDiv);
                        
                        const monthsContainer = document.createElement('div');
                        monthsContainer.className = 'months-container visible';
                        monthsContainer.id = `months${year}`;
                        
                        const months = Array.from(availableMonths.get(year) || new Set()).sort((a, b) => a - b);
                        months.forEach(mes => {
                            const monthDiv = document.createElement('div');
                            monthDiv.className = 'form-check';
                            monthDiv.innerHTML = `
                                <input class="form-check-input month-checkbox" type="checkbox" data-year="${year}" value="${mes}" checked>
                                <label class="form-check-label">${String(mes).padStart(2, '0')}</label>
                            `;
                            monthsContainer.appendChild(monthDiv);
                        });
                        
                        yearCard.appendChild(monthsContainer);
                        yearCheckboxesContainer.appendChild(yearCard);
                    });

                    document.querySelectorAll('.year-checkbox').forEach(cb => {
                        cb.addEventListener('change', (e) => {
                            const year = parseInt(e.target.value);
                            const monthsContainer = document.getElementById(`months${year}`);
                            const monthCheckboxes = monthsContainer.querySelectorAll('.month-checkbox');
                            if (e.target.checked) {
                                monthsContainer.classList.add('visible');
                                monthCheckboxes.forEach(mcb => mcb.checked = true);
                            } else {
                                monthsContainer.classList.remove('visible');
                                monthCheckboxes.forEach(mcb => mcb.checked = false);
                            }
                            checkAnalyzeButton();
                            updateSelectedPeriods();
                        });
                    });

                    document.querySelectorAll('.month-checkbox').forEach(mcb => {
                        mcb.addEventListener('change', () => {
                            checkAnalyzeButton();
                            updateSelectedPeriods();
                        });
                    });

                    updateSelectedPeriods();
                    checkAnalyzeButton();
                    clearFiltersBtn.disabled = false;
                    
                    initializeClientSearch();
                } catch (error) {
                    showError(`Erro ao carregar dados da planilha: ${error.message}`);
                    console.error('Erro ao carregar dados:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Inicializar a funcionalidade de pesquisa de clientes
        function initializeClientSearch() {
            selectedClients.clear();
            updateSelectedClientsDisplay();
            
            clientSearch.addEventListener('input', handleClientSearch);
            clearClientSelectionBtn.addEventListener('click', clearAllFilters);
            
            document.addEventListener('click', (e) => {
                if (!clientSearch.contains(e.target) && !clientSearchResults.contains(e.target)) {
                    clientSearchResults.classList.add('hidden');
                }
            });
        }

        // Manipular pesquisa inteligente de clientes
        function handleClientSearch() {
            clearTimeout(searchTimeout);
            const searchTerm = clientSearch.value.trim().toLowerCase();
            
            if (searchTerm.length === 0) {
                clientSearchResults.classList.add('hidden');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                // Busca inteligente: nome completo, partes do nome, iniciais
                filteredClients = Array.from(allClients).filter(client => {
                    const clientLower = client.toLowerCase();
                    // Busca por substring
                    if (clientLower.includes(searchTerm)) return true;
                    
                    // Busca por palavras separadas
                    const searchWords = searchTerm.split(' ').filter(w => w.length > 0);
                    const clientWords = clientLower.split(' ').filter(w => w.length > 0);
                    
                    return searchWords.every(searchWord => 
                        clientWords.some(clientWord => 
                            clientWord.startsWith(searchWord) || clientWord.includes(searchWord)
                        )
                    );
                }).sort();
                
                displayClientSearchResults(filteredClients);
            }, 200);
        }

        // Exibir resultados melhorados da pesquisa de clientes
        function displayClientSearchResults(clients) {
            clientSearchResults.innerHTML = '';
            
            if (clients.length === 0) {
                clientSearchResults.innerHTML = '<div class="client-search-item">‚ùå Nenhum cliente encontrado</div>';
                clientSearchResults.classList.remove('hidden');
                return;
            }
            
            // Adicionar checkbox "Selecionar Todos"
            const selectAllItem = document.createElement('div');
            selectAllItem.className = 'client-search-select-all';
            selectAllItem.innerHTML = `
                <input type="checkbox" class="client-search-checkbox" id="selectAllClients">
                <label for="selectAllClients">‚úÖ Selecionar Todos (${clients.length} cliente${clients.length > 1 ? 's' : ''})</label>
            `;
            
            const selectAllCheckbox = selectAllItem.querySelector('#selectAllClients');
            selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                if (isChecked) {
                    clients.forEach(client => selectedClients.add(client));
                } else {
                    clients.forEach(client => selectedClients.delete(client));
                }
                updateSelectedClientsDisplay();
                displayClientSearchResults(clients);
                checkAnalyzeButton();
            });
            
            clientSearchResults.appendChild(selectAllItem);
            
            // Adicionar cada cliente com destaque na busca
            clients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'client-search-item';
                if (selectedClients.has(client)) {
                    item.classList.add('selected');
                }
                
                // Destacar termo de busca
                const searchTerm = clientSearch.value.trim().toLowerCase();
                let displayName = client;
                if (searchTerm.length > 0) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    displayName = client.replace(regex, '<mark>$1</mark>');
                }
                
                item.innerHTML = `
                    <input type="checkbox" class="client-search-checkbox" ${selectedClients.has(client) ? 'checked' : ''} data-client="${client}">
                    <span>${displayName}</span>
                `;
                
                const checkbox = item.querySelector('.client-search-checkbox');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        selectedClients.add(client);
                    } else {
                        selectedClients.delete(client);
                    }
                    updateSelectedClientsDisplay();
                    displayClientSearchResults(clients);
                    checkAnalyzeButton();
                });
                
                item.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                clientSearchResults.appendChild(item);
            });
            
            clientSearchResults.classList.remove('hidden');
        }

        // CORRE√á√ÉO: Limpar sele√ß√£o de clientes - agora limpa tamb√©m a caixa de pesquisa
        function clearClientSelection() {
            selectedClients.clear();
            updateSelectedClientsDisplay();
            clientSearch.value = ''; // CORRE√á√ÉO: Limpar a caixa de pesquisa
            clientSearchResults.classList.add('hidden');
            checkAnalyzeButton();
        }

        // Atualizar exibi√ß√£o melhorada de clientes selecionados
        function updateSelectedClientsDisplay() {
            selectedClientsContainer.innerHTML = '';
            
            if (selectedClients.size === 0) {
                selectedClientsContainer.classList.add('hidden');
                return;
            }
            
            selectedClientsContainer.classList.remove('hidden');
            
            // Adicionar contador
            const counterDiv = document.createElement('div');
            counterDiv.className = 'mb-2 text-muted';
            counterDiv.innerHTML = `<small><strong>${selectedClients.size}</strong> cliente${selectedClients.size > 1 ? 's' : ''} selecionado${selectedClients.size > 1 ? 's' : ''}:</small>`;
            selectedClientsContainer.appendChild(counterDiv);
            
            Array.from(selectedClients).sort().forEach(client => {
                const tag = document.createElement('div');
                tag.className = 'selected-client-tag';
                tag.innerHTML = `
                    ${client}
                    <button type="button" data-client="${client}" title="Remover cliente">&times;</button>
                `;
                
                tag.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedClients.delete(client);
                    updateSelectedClientsDisplay();
                    displayClientSearchResults(filteredClients);
                    checkAnalyzeButton();
                });
                
                selectedClientsContainer.appendChild(tag);
            });
        }

        // Fun√ß√£o para atualizar anos e meses selecionados
        function updateSelectedPeriods() {
            selectedYears = Array.from(document.querySelectorAll('.year-checkbox:checked')).map(cb => parseInt(cb.value));
            selectedMonths = new Map();
            selectedYears.forEach(year => {
                const monthsChecked = Array.from(document.querySelectorAll(`.month-checkbox[data-year="${year}"]:checked`)).map(mcb => parseInt(mcb.value));
                if (monthsChecked.length > 0) {
                    selectedMonths.set(year, new Set(monthsChecked));
                }
            });
            updateDashboardTitle(selectedCompany, selectedYears);
        }

        // Fun√ß√£o para verificar se o bot√£o de an√°lise deve ser habilitado
        function checkAnalyzeButton() {
            const hasSelectedYears = document.querySelectorAll('.year-checkbox:checked').length > 0;
            const hasSelectedClients = selectedClients.size > 0;
            
            analyzeBtn.disabled = !fileInput.files.length || !dateLimit.value || 
                                 (!hasSelectedYears && !hasSelectedClients);
        }

        // CORRE√á√ÉO: Fun√ß√£o para limpar todos os filtros - agora esconde completamente o dashboard
        function clearAllFilters() {
            companySelect.value = '';
            selectedCompany = '';
            
            document.querySelectorAll('.year-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.querySelectorAll('.month-checkbox').forEach(mcb => {
                mcb.checked = false;
            });
            document.querySelectorAll('.months-container').forEach(mc => {
                mc.classList.remove('visible');
            });
            
            dateLimit.value = todayFormatted;
            
            selectedClients.clear();
            updateSelectedClientsDisplay();
            clientSearch.value = '';
            clientSearchResults.classList.add('hidden');
            
            updateSelectedPeriods();
            updateDashboardTitle('', []);
            analyzeBtn.disabled = true;
            
            // CORRE√á√ÉO: Esconder completamente o dashboard
            dashboard.classList.add('hidden');
            
            // Limpar conte√∫dos residuais
            resumoGrid.innerHTML = '';
            const empresasSection = document.getElementById('empresasSection');
            empresasSection.classList.add('hidden');
            const empresasGrid = document.getElementById('empresasGrid');
            empresasGrid.innerHTML = '';
            const existingMonthsSection = document.getElementById('monthsSection');
            if (existingMonthsSection) {
                existingMonthsSection.remove();
            }
            document.querySelector('#tableCliente tbody').innerHTML = '';
            mesSubcards.innerHTML = '';
            document.querySelector('#tableVendedor tbody').innerHTML = '';
            document.querySelector('#tableClienteVendedor tbody').innerHTML = '';
            vendedorMesSubcards.innerHTML = '';
            futureSubcards.innerHTML = '';
            
            console.log('Todos os filtros foram limpos, dashboard ocultado');
        }

        // Fun√ß√£o para iniciar an√°lise
        function startAnalysis() {
            console.log('Bot√£o "Iniciar An√°lise" clicado');
            loadingIndicator.classList.remove('hidden');
            analyzeBtn.disabled = true;
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
            
            const file = fileInput.files[0];
            if (!file) {
                showError('Nenhum arquivo selecionado.');
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                return;
            }
            if (!dateLimit.value) {
                showError('Por favor, selecione uma data limite.');
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    console.log('Iniciando leitura da planilha');
                    const bytes = e.target.result;
                    const workbook = XLSX.read(bytes, { type: 'array' });
                    
                    if (!workbook.Sheets['Inadimpl√™ncia']) {
                        throw new Error('A aba "Inadimpl√™ncia" n√£o foi encontrada na planilha.');
                    }
                    
                    data = XLSX.utils.sheet_to_json(workbook.Sheets['Inadimpl√™ncia'], { header: 1 }).slice(1);
                    console.log('Dados brutos lidos:', data);
                    data = data.filter(row => row.length > 0 && row[0]);
                    
                    if (data.length === 0) {
                        throw new Error('Nenhum dado v√°lido encontrado na planilha.');
                    }
                    
                    console.log('Iniciando processamento dos dados');
                    processData();
                } catch (error) {
                    showError(`Erro ao processar a planilha: ${error.message}`);
                    console.error('Erro no processamento:', error);
                    loadingIndicator.classList.add('hidden');
                    analyzeBtn.disabled = false;
                }
            };
            reader.onerror = () => {
                showError('Erro ao ler o arquivo. Verifique se √© um arquivo XLSX v√°lido.');
                console.error('Erro na leitura do arquivo');
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
            };
            reader.readAsArrayBuffer(file);
        }

        // Fun√ß√£o para exibir mensagens de erro
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Fun√ß√£o para formatar valores em R$
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Fun√ß√£o para formatar data como DD/MM/AAAA
        function formatDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        // Fun√ß√£o principal para processar dados e preencher tabelas
        function processData() {
            try {
                updateSelectedPeriods();
                console.log('Anos selecionados:', selectedYears);
                console.log('Meses selecionados:', selectedMonths);
                
                if (selectedYears.length === 0 && selectedClients.size === 0) {
                    showError('Por favor, selecione pelo menos um ano ou cliente para a pesquisa.');
                    loadingIndicator.classList.add('hidden');
                    analyzeBtn.disabled = false;
                    return;
                }

                updateDashboardTitle(selectedCompany, selectedYears);

                function serialToDate(serial) {
                    if (typeof serial !== 'number' || isNaN(serial)) return null;
                    return new Date((serial - 25569) * 86400 * 1000);
                }

                function getMonthStr(date) {
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }

                const limitDate = new Date(dateLimit.value);
                limitDate.setHours(23, 59, 59, 999);

                const limitDateFormatted = formatDate(dateLimit.value);

                const processedData = [];
                const futureData = [];
                const clienteStats = new Map();
                const mesStats = new Map();
                const vendedorStats = new Map();
                const clienteVendedorStats = new Map();
                const pivotVendedorMes = new Map();
                const pivotSemVendedorMes = new Map();
                const empresaStats = new Map();
                const clientesSet = new Set();
                const mesesSet = new Set();
                const vendedoresSet = new Set();
                const empresasSet = new Set();
                let totalTitulos = 0;
                let totalValor = 0;

                console.log('Iniciando loop de processamento com ' + data.length + ' linhas');
                console.log('Filtrando por empresa:', selectedCompany);
                console.log('Filtrando por clientes selecionados:', selectedClients.size > 0 ? Array.from(selectedClients) : 'Todos');
                
                data.forEach((row, index) => {
                    try {
                        const cliente = row[0] ? String(row[0]).trim() : '';
                        const serial = row[1];
                        const vencimento = serialToDate(serial);
                        const valorStr = row[3];
                        const valor = parseFloat(valorStr) || 0;
                        const liquidacao = row[4];
                        const vendedor = row[5] ? String(row[5]).trim() : '';
                        const empresaEmissora = row[7] ? String(row[7]).trim() : '';

                        if (selectedCompany && selectedCompany !== '' && empresaEmissora !== selectedCompany) {
                            return;
                        }

                        if (selectedClients.size > 0 && !selectedClients.has(cliente)) {
                            return;
                        }

                        if (cliente && vencimento && (liquidacao === undefined || liquidacao === '') && !isNaN(valor)) {
                            const ano = vencimento.getFullYear();
                            const mes = vencimento.getMonth() + 1;
                            const selectedMesesForAno = selectedMonths.get(ano) || new Set();
                            if ((selectedYears.length === 0 || selectedYears.includes(ano)) && (selectedMesesForAno.size === 0 || selectedMesesForAno.has(mes))) {
                                console.log(`Processando linha ${index + 2}: cliente=${cliente}, vencimento=${vencimento.toISOString().slice(0,10)}, valor=${valor}`);
                                const vencimentoEndOfDay = new Date(vencimento);
                                vencimentoEndOfDay.setHours(23, 59, 59, 999);
                                if (vencimentoEndOfDay <= limitDate) {
                                    processedData.push({ cliente, vencimento, valor, vendedor, empresaEmissora });
                                    const mesStr = getMonthStr(vencimento);

                                    clientesSet.add(cliente);
                                    mesesSet.add(mesStr);
                                    if (vendedor) vendedoresSet.add(vendedor);
                                    if (empresaEmissora) empresasSet.add(empresaEmissora);

                                    // Stats por cliente
                                    if (!clienteStats.has(cliente)) clienteStats.set(cliente, { count: 0, sum: 0 });
                                    const cStats = clienteStats.get(cliente);
                                    cStats.count++;
                                    cStats.sum += valor;

                                    // Stats por m√™s
                                    if (!mesStats.has(mesStr)) mesStats.set(mesStr, { count: 0, sum: 0 });
                                    const mStats = mesStats.get(mesStr);
                                    mStats.count++;
                                    mStats.sum += valor;

                                    // Stats por vendedor
                                    const vendedorKey = vendedor || 'Sem Vendedor';
                                    if (!vendedorStats.has(vendedorKey)) vendedorStats.set(vendedorKey, { count: 0, sum: 0 });
                                    const vStats = vendedorStats.get(vendedorKey);
                                    vStats.count++;
                                    vStats.sum += valor;

                                    // Stats por cliente e vendedor
                                    const clienteVendedorKey = `${cliente}|${vendedorKey}`;
                                    if (!clienteVendedorStats.has(clienteVendedorKey)) clienteVendedorStats.set(clienteVendedorKey, { count: 0, sum: 0, cliente, vendedor: vendedorKey });
                                    const cvStats = clienteVendedorStats.get(clienteVendedorKey);
                                    cvStats.count++;
                                    cvStats.sum += valor;

                                    // Pivot vendedor x m√™s
                                    if (vendedor) {
                                        if (!pivotVendedorMes.has(vendedor)) pivotVendedorMes.set(vendedor, new Map());
                                        const vMap = pivotVendedorMes.get(vendedor);
                                        if (!vMap.has(mesStr)) vMap.set(mesStr, 0);
                                        vMap.set(mesStr, vMap.get(mesStr) + valor);
                                    } else {
                                        if (!pivotSemVendedorMes.has(mesStr)) pivotSemVendedorMes.set(mesStr, 0);
                                        pivotSemVendedorMes.set(mesStr, pivotSemVendedorMes.get(mesStr) + valor);
                                    }

                                    // Stats por empresa
                                    if (empresaEmissora) {
                                        if (!empresaStats.has(empresaEmissora)) empresaStats.set(empresaEmissora, { count: 0, sum: 0 });
                                        const eStats = empresaStats.get(empresaEmissora);
                                        eStats.count++;
                                        eStats.sum += valor;
                                    }

                                    totalTitulos++;
                                    totalValor += valor;
                                } else {
                                    futureData.push({ cliente, vencimento, valor, vendedor, empresaEmissora });
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`Erro ao processar linha ${index + 2}:`, error);
                    }
                });

                console.log('Processamento conclu√≠do. T√≠tulos encontrados:', totalTitulos);

                if (processedData.length === 0) {
                    showError('Nenhum t√≠tulo encontrado com os crit√©rios selecionados.');
                    loadingIndicator.classList.add('hidden');
                    analyzeBtn.disabled = false;
                    return;
                }

                // Preencher resumo geral
                fillResumoGeral(totalTitulos, totalValor, clientesSet.size, vendedoresSet.size, limitDateFormatted, empresaStats, mesStats);

                // Preencher tabela de clientes MELHORADA
                fillTableClienteComHistorico(clienteStats, empresaStats);

                // Preencher demais tabelas (mantidas originais)
                fillTableVendedor(vendedorStats);
                fillTableClienteVendedor(clienteVendedorStats, empresaStats);
                fillMesSubcards(mesStats);
                fillVendedorMesSubcards(pivotVendedorMes, pivotSemVendedorMes, mesesSet);
                fillFutureSubcards(futureData, limitDateFormatted);

                // Exibir dashboard
                loadingIndicator.classList.add('hidden');
                dashboard.classList.remove('hidden');
                analyzeBtn.disabled = false;
            } catch (error) {
                showError(`Erro ao processar os dados: ${error.message}`);
                console.error('Erro no processamento:', error);
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        // Fun√ß√£o para preencher o resumo geral
        function fillResumoGeral(totalTitulos, totalValor, totalClientes, totalVendedores, limitDateFormatted, empresaStats, mesStats) {
            resumoGrid.innerHTML = '';
            
            const resumoItems = [
                { label: 'Total de T√≠tulos', value: totalTitulos, format: 'number' },
                { label: 'Valor Total', value: totalValor, format: 'currency' },
                { label: 'Total de Clientes', value: totalClientes, format: 'number' },
                { label: 'Total de Vendedores', value: totalVendedores, format: 'number' },
                { label: 'Valor M√©dio por T√≠tulo', value: totalTitulos > 0 ? totalValor / totalTitulos : 0, format: 'currency' },
                { label: 'Data Limite', value: limitDateFormatted, format: 'text' }
            ];
            
            resumoItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'resumo-item';
                
                const valueDiv = document.createElement('div');
                valueDiv.className = 'resumo-value';
                
                if (item.format === 'currency') {
                    valueDiv.textContent = formatCurrency(item.value);
                } else if (item.format === 'number') {
                    valueDiv.textContent = item.value.toLocaleString('pt-BR');
                } else {
                    valueDiv.textContent = item.value;
                }
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'resumo-label';
                labelDiv.textContent = item.label;
                
                div.appendChild(valueDiv);
                div.appendChild(labelDiv);
                resumoGrid.appendChild(div);
            });

            // Adicionar cards de empresas
            const empresasSection = document.getElementById('empresasSection');
            const empresasGrid = document.getElementById('empresasGrid');
            empresasGrid.innerHTML = '';

            if (empresaStats.size > 0) {
                empresasSection.classList.remove('hidden');
                
                const sortedEmpresas = Array.from(empresaStats.entries()).sort((a, b) => b[1].sum - a[1].sum);
                
                sortedEmpresas.forEach(([empresa, stats]) => {
                    const div = document.createElement('div');
                    div.className = 'resumo-empresa-item';
                    
                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'resumo-empresa-value';
                    valueDiv.textContent = formatCurrency(stats.sum);
                    
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'resumo-empresa-label';
                    labelDiv.textContent = empresa;
                    
                    const countDiv = document.createElement('div');
                    countDiv.style.fontSize = '0.8rem';
                    countDiv.style.color = '#999';
                    countDiv.textContent = `${stats.count} t√≠tulo${stats.count > 1 ? 's' : ''}`;
                    
                    div.appendChild(valueDiv);
                    div.appendChild(labelDiv);
                    div.appendChild(countDiv);
                    empresasGrid.appendChild(div);
                });
            } else {
                empresasSection.classList.add('hidden');
            }

            // Remover se√ß√£o de meses existente, se houver
            const existingMonthsSection = document.getElementById('monthsSection');
            if (existingMonthsSection) {
                existingMonthsSection.remove();
            }

            // Adicionar se√ß√£o de meses
            const monthsSection = document.createElement('div');
            monthsSection.id = 'monthsSection';
            monthsSection.className = 'mt-4';
            monthsSection.innerHTML = '<h6 class="mb-3">üìÖ Distribui√ß√£o por M√™s Selecionado</h6>';
            const monthsGrid = document.createElement('div');
            monthsGrid.id = 'monthsGrid';
            monthsGrid.className = 'resumo-grid';
            monthsSection.appendChild(monthsGrid);
            document.querySelector('.resumo-card .card-body').appendChild(monthsSection);

            const sortedMeses = Array.from(mesStats.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            if (sortedMeses.length > 0) {
                monthsSection.classList.remove('hidden');
                sortedMeses.forEach(([mes, stats]) => {
                    const [ano, mesNum] = mes.split('-');
                    const mesNome = new Date(ano, mesNum - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    const div = document.createElement('div');
                    div.className = 'resumo-empresa-item';
                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'resumo-empresa-value';
                    valueDiv.textContent = formatCurrency(stats.sum);
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'resumo-empresa-label';
                    labelDiv.textContent = mesNome;
                    const countDiv = document.createElement('div');
                    countDiv.style.fontSize = '0.8rem';
                    countDiv.style.color = '#999';
                    countDiv.textContent = `${stats.count} t√≠tulo${stats.count > 1 ? 's' : ''}`;
                    div.appendChild(valueDiv);
                    div.appendChild(labelDiv);
                    div.appendChild(countDiv);
                    monthsGrid.appendChild(div);
                });

                // Insights em cards lineares
                const insightsSection = document.createElement('div');
                insightsSection.className = 'insights-grid';
                let maxMes = sortedMeses.reduce((max, current) => current[1].sum > max[1].sum ? current : max);
                const [anoMax, mesNumMax] = maxMes[0].split('-');
                const mesNomeMax = new Date(anoMax, mesNumMax - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const maxInsight = document.createElement('div');
                maxInsight.className = 'insight-item';
                const maxValue = document.createElement('div');
                maxValue.className = 'insight-value';
                maxValue.textContent = `M√™s com maior inadimpl√™ncia: ${mesNomeMax} (${formatCurrency(maxMes[1].sum)})`;
                maxInsight.appendChild(maxValue);
                insightsSection.appendChild(maxInsight);

                if (sortedMeses.length > 1) {
                    for (let i = 1; i < sortedMeses.length; i++) {
                        const prev = sortedMeses[i-1][1].sum;
                        const curr = sortedMeses[i][1].sum;
                        const change = prev !== 0 ? ((curr - prev) / prev * 100).toFixed(2) : 'N/A';
                        const [anoPrev, mesNumPrev] = sortedMeses[i-1][0].split('-');
                        const [anoCurr, mesNumCurr] = sortedMeses[i][0].split('-');
                        const mesNomePrev = new Date(anoPrev, mesNumPrev - 1, 1).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                        const mesNomeCurr = new Date(anoCurr, mesNumCurr - 1, 1).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                        let changeText = '';
                        if (change !== 'N/A') {
                            const absChange = Math.abs(change);
                            const direction = change > 0 ? 'aumento' : 'redu√ß√£o';
                            changeText = `${direction} de ${absChange}%`;
                        } else {
                            changeText = 'N/A';
                        }
                        const insightDiv = document.createElement('div');
                        insightDiv.className = 'insight-item';
                        const insightValue = document.createElement('div');
                        insightValue.className = 'insight-value';
                        insightValue.textContent = `De ${mesNomePrev} para ${mesNomeCurr}: ${changeText}`;
                        insightDiv.appendChild(insightValue);
                        insightsSection.appendChild(insightDiv);
                    }
                } else {
                    const noComp = document.createElement('div');
                    noComp.className = 'insight-item';
                    const noCompValue = document.createElement('div');
                    noCompValue.className = 'insight-value';
                    noCompValue.textContent = 'Apenas um m√™s selecionado, sem compara√ß√µes dispon√≠veis.';
                    noComp.appendChild(noCompValue);
                    insightsSection.appendChild(noComp);
                }
                monthsGrid.appendChild(insightsSection);
            } else {
                monthsSection.classList.add('hidden');
            }
        }

        // Fun√ß√£o NOVA para preencher tabela de clientes com funcionalidade de hist√≥rica
        function fillTableClienteComHistorico(clienteStats, empresaStats) {
            const tbody = document.querySelector('#tableCliente tbody');
            tbody.innerHTML = '';
            
            const sortedClientes = Array.from(clienteStats.entries()).sort((a, b) => b[1].sum - a[1].sum);
            
            sortedClientes.forEach(([cliente, stats]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="client-name-clickable" onclick="abrirHistoricoCliente('${cliente.replace(/'/g, "\\'")}')">
                            üìä ${cliente}
                        </span>
                    </td>
                    <td>${stats.count}</td>
                    <td>${formatCurrency(stats.sum)}</td>
                    <td>
                        <button class="btn-ver-historico" onclick="abrirHistoricoCliente('${cliente.replace(/'/g, "\\'")}')">
                            üìã Ver Hist√≥rico
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Adicionar linha de total
            const totalRow = document.createElement('tr');
            totalRow.className = 'table-total';
            const totalTitulos = Array.from(clienteStats.values()).reduce((sum, stats) => sum + stats.count, 0);
            const totalValor = Array.from(clienteStats.values()).reduce((sum, stats) => sum + stats.sum, 0);
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td><strong>${totalTitulos}</strong></td>
                <td><strong>${formatCurrency(totalValor)}</strong></td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
        }

        // Fun√ß√£o para abrir modal de hist√≥rico do cliente
        function abrirHistoricoCliente(nomeCliente) {
            console.log('Abrindo hist√≥rico para cliente:', nomeCliente);
            clienteHistoricoAtual = nomeCliente;
            
            // Atualizar t√≠tulo do modal
            modalClienteNome.textContent = nomeCliente;
            
            // Processar dados do hist√≥rico
            const historicoData = processarHistoricoCliente(nomeCliente);
            
            // Preencher per√≠odo de an√°lise
            modalPeriodoInfo.innerHTML = `
                <div class="d-flex gap-3">
                    <div><strong>üìÖ Data Limite:</strong> ${formatDate(dateLimit.value)}</div>
                    <div><strong>üè¢ Empresa:</strong> ${selectedCompany || 'Todas as Empresas'}</div>
                    <div><strong>üìä Anos:</strong> ${selectedYears.length > 0 ? selectedYears.join(', ') : 'Todos'}</div>
                </div>
            `;
            
            // Preencher resumo geral do cliente
            modalResumoGeral.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="historico-stat">
                            <div class="historico-stat-value">${historicoData.totalTitulos}</div>
                            <div class="historico-stat-label">Total de T√≠tulos</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="historico-stat">
                            <div class="historico-stat-value">${formatCurrency(historicoData.totalValor)}</div>
                            <div class="historico-stat-label">Valor Total</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="historico-stat">
                            <div class="historico-stat-value">${formatCurrency(historicoData.valorMedio)}</div>
                            <div class="historico-stat-label">Valor M√©dio</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="historico-stat">
                            <div class="historico-stat-value">${historicoData.anosEnvolvidos}</div>
                            <div class="historico-stat-label">Anos Envolvidos</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Preencher conte√∫do do hist√≥rico
            preencherHistoricoTimeline(historicoData.timelineData);
            
            // Exibir modal
            modalHistoricoCliente.show();
        }

        // CORRE√á√ÉO: Fun√ß√£o para processar dados hist√≥ricos de um cliente espec√≠fico
        function processarHistoricoCliente(nomeCliente) {
            const limitDate = new Date(dateLimit.value);
            limitDate.setHours(23, 59, 59, 999);
            
            function serialToDate(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                return new Date((serial - 25569) * 86400 * 1000);
            }
            
            // CORRE√á√ÉO: Usar originalData em vez de data
            const clienteTitulos = [];
            const anoStats = new Map();
            
            originalData.forEach((row, index) => {
                try {
                    const cliente = row[0] ? String(row[0]).trim() : '';
                    const serial = row[1];
                    const vencimento = serialToDate(serial);
                    const valorStr = row[3];
                    const valor = parseFloat(valorStr) || 0;
                    const liquidacao = row[4];
                    const vendedor = row[5] ? String(row[5]).trim() : '';
                    const empresaEmissora = row[7] ? String(row[7]).trim() : '';
                    
                    // CORRE√á√ÉO: Filtrar apenas para o cliente espec√≠fico
                    if (cliente !== nomeCliente) return;
                    
                    // Aplicar filtro de empresa se selecionada
                    if (selectedCompany && selectedCompany !== '' && empresaEmissora !== selectedCompany) {
                        return;
                    }
                    
                    // CORRE√á√ÉO: Verificar se vencimento √© v√°lido
                    if (vencimento && vencimento instanceof Date && !isNaN(vencimento.getTime())) {
                        const ano = vencimento.getFullYear();
                        const mes = vencimento.getMonth() + 1;
                        
                        // Se anos foram selecionados, filtrar por anos; caso contr√°rio, incluir todos
                        const selectedMesesForAno = selectedMonths.get(ano) || new Set();
                        if ((selectedYears.length === 0 || selectedYears.includes(ano)) && (selectedMesesForAno.size === 0 || selectedMesesForAno.has(mes))) {
                            // CORRE√á√ÉO: Incluir apenas t√≠tulos n√£o liquidados e com vencimento at√© a data limite
                            const vencimentoEndOfDay = new Date(vencimento);
                            vencimentoEndOfDay.setHours(23, 59, 59, 999);
                            if ((liquidacao === undefined || liquidacao === null || liquidacao === '') && vencimentoEndOfDay <= limitDate) {
                                clienteTitulos.push({
                                    cliente,
                                    vencimento,
                                    valor,
                                    vendedor: vendedor || 'Sem Vendedor',
                                    empresaEmissora: empresaEmissora || 'N√£o Informado',
                                    ano
                                });
                                
                                // Estat√≠sticas por ano
                                if (!anoStats.has(ano)) {
                                    anoStats.set(ano, { count: 0, sum: 0, titulos: [] });
                                }
                                const yearStats = anoStats.get(ano);
                                yearStats.count++;
                                yearStats.sum += valor;
                                yearStats.titulos.push({
                                    vencimento,
                                    valor,
                                    vendedor: vendedor || 'Sem Vendedor',
                                    empresaEmissora: empresaEmissora || 'N√£o Informado'
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.warn(`Erro ao processar linha ${index + 2} para hist√≥rico:`, error);
                }
            });
            
            // Calcular estat√≠sticas gerais
            const totalTitulos = clienteTitulos.length;
            const totalValor = clienteTitulos.reduce((sum, titulo) => sum + titulo.valor, 0);
            const valorMedio = totalTitulos > 0 ? totalValor / totalTitulos : 0;
            const anosEnvolvidos = anoStats.size;
            
            // Preparar dados da timeline
            const timelineData = Array.from(anoStats.entries())
                .sort((a, b) => b[0] - a[0]) // Ordenar por ano decrescente
                .map(([ano, stats]) => ({
                    ano,
                    count: stats.count,
                    sum: stats.sum,
                    titulos: stats.titulos.sort((a, b) => b.vencimento - a.vencimento) // Ordenar t√≠tulos por vencimento decrescente
                }));
            
            return {
                totalTitulos,
                totalValor,
                valorMedio,
                anosEnvolvidos,
                timelineData
            };
        }

        // CORRE√á√ÉO: Fun√ß√£o para preencher a timeline do hist√≥rico - tratamento para dados vazios
        function preencherHistoricoTimeline(timelineData) {
            modalHistoricoContent.innerHTML = '';
            
            if (timelineData.length === 0) {
                modalHistoricoContent.innerHTML = `
                    <div class="text-center py-4">
                        <h5>‚ùå Nenhum t√≠tulo encontrado para este cliente nos crit√©rios selecionados</h5>
                        <p class="text-muted">Verifique os filtros aplicados (empresa, anos, data limite)</p>
                    </div>
                `;
                return;
            }
            
            timelineData.forEach(anoData => {
                // CORRE√á√ÉO: Verificar se h√° t√≠tulos para este ano
                if (anoData.titulos.length === 0) return;
                
                const anoDiv = document.createElement('div');
                anoDiv.className = 'historico-item';
                
                anoDiv.innerHTML = `
                    <div class="historico-ano-header">
                        üìÖ Ano ${anoData.ano}
                    </div>
                    
                    <div class="historico-stats">
                        <div class="historico-stat">
                            <div class="historico-stat-value">${anoData.count}</div>
                            <div class="historico-stat-label">T√≠tulos</div>
                        </div>
                        <div class="historico-stat">
                            <div class="historico-stat-value">${formatCurrency(anoData.sum)}</div>
                            <div class="historico-stat-label">Valor Total</div>
                        </div>
                        <div class="historico-stat">
                            <div class="historico-stat-value">${formatCurrency(anoData.sum / anoData.count)}</div>
                            <div class="historico-stat-label">Valor M√©dio</div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>üìã Detalhamento dos T√≠tulos:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm historico-titulos-table">
                                <thead>
                                    <tr>
                                        <th>Data Vencimento</th>
                                        <th>Valor</th>
                                        <th>Vendedor</th>
                                        <th>Empresa</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${anoData.titulos.map(titulo => `
                                        <tr>
                                            <td>${titulo.vencimento.toLocaleDateString('pt-BR')}</td>
                                            <td>${formatCurrency(titulo.valor)}</td>
                                            <td>${titulo.vendedor}</td>
                                            <td>${titulo.empresaEmissora}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                modalHistoricoContent.appendChild(anoDiv);
            });
        }

        // NOVA FUN√á√ÉO: Visualizar PDF do cliente
        function visualizarPdfCliente() {
            if (!clienteHistoricoAtual) {
                alert('Erro: Nenhum cliente selecionado para visualizar PDF.');
                return;
            }
            
            try {
                const pdfDoc = gerarPdfClienteDocumento(clienteHistoricoAtual);
                const pdfBlob = pdfDoc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Abrir PDF em nova aba
                window.open(pdfUrl, '_blank');
                
            } catch (error) {
                console.error('Erro ao visualizar PDF do cliente:', error);
                alert('Erro ao visualizar PDF. Verifique o console para mais detalhes.');
            }
        }

        // FUN√á√ÉO REFATORADA: Gerar documento PDF do cliente (sem salvar)
        function gerarPdfClienteDocumento(nomeCliente) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a4');
            let yPosition = 20;
            
            // T√≠tulo principal
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`Hist√≥rico de Inadimpl√™ncia - ${nomeCliente}`, 20, yPosition);
            yPosition += 10;
            
            // Informa√ß√µes do per√≠odo
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Data Limite: ${formatDate(dateLimit.value)}`, 20, yPosition);
            doc.text(`Empresa: ${selectedCompany || 'Todas as Empresas'}`, 110, yPosition);
            yPosition += 5;
            doc.text(`Anos: ${selectedYears.length > 0 ? selectedYears.join(', ') : 'Todos'}`, 20, yPosition);
            yPosition += 15;
            
            // Processar dados do hist√≥rico
            const historicoData = processarHistoricoCliente(nomeCliente);
            
            // Resumo geral
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Resumo Geral:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de T√≠tulos: ${historicoData.totalTitulos}`, 20, yPosition);
            doc.text(`Valor Total: ${formatCurrency(historicoData.totalValor)}`, 110, yPosition);
            yPosition += 5;
            doc.text(`Valor M√©dio: ${formatCurrency(historicoData.valorMedio)}`, 20, yPosition);
            doc.text(`Anos Envolvidos: ${historicoData.anosEnvolvidos}`, 110, yPosition);
            yPosition += 15;
            
            // Detalhamento por ano
            historicoData.timelineData.forEach(anoData => {
                // Verificar se precisa de nova p√°gina
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // T√≠tulo do ano
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Ano ${anoData.ano}`, 20, yPosition);
                yPosition += 8;
                
                // Estat√≠sticas do ano
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`T√≠tulos: ${anoData.count}`, 20, yPosition);
                doc.text(`Valor Total: ${formatCurrency(anoData.sum)}`, 70, yPosition);
                doc.text(`Valor M√©dio: ${formatCurrency(anoData.sum / anoData.count)}`, 140, yPosition);
                yPosition += 10;
                
                // Tabela de t√≠tulos - CORRE√á√ÉO: Incluir empresa emissora
                const tableData = anoData.titulos.map(titulo => [
                    titulo.vencimento.toLocaleDateString('pt-BR'),
                    formatCurrency(titulo.valor),
                    titulo.vendedor,
                    titulo.empresaEmissora || 'N√£o Informado' // CORRE√á√ÉO: Incluir empresa
                ]);
                
                doc.autoTable({
                    startY: yPosition,
                    head: [['Data Vencimento', 'Valor', 'Vendedor', 'Empresa Emissora']], // CORRE√á√ÉO: Adicionar coluna empresa
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [0, 123, 255] },
                    margin: { left: 20, right: 20 },
                    // MELHORIA: Distribui√ß√£o de colunas
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 30 },
                        2: { cellWidth: 40 },
                        3: { cellWidth: 55 }
                    }
                });
                
                yPosition = doc.lastAutoTable.finalY + 10;
            });
            
            return doc;
        }

        // FUN√á√ÉO ORIGINAL MODIFICADA: Gerar PDF do cliente espec√≠fico (para download)
        function gerarPdfCliente() {
            if (!clienteHistoricoAtual) {
                alert('Erro: Nenhum cliente selecionado para gerar PDF.');
                return;
            }
            
            try {
                const doc = gerarPdfClienteDocumento(clienteHistoricoAtual);
                
                // Salvar PDF
                const fileName = `Historico_Inadimplencia_${clienteHistoricoAtual.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('Erro ao gerar PDF do cliente:', error);
                alert('Erro ao gerar PDF. Verifique o console para mais detalhes.');
            }
        }

        // Fun√ß√µes auxiliares para preencher as demais tabelas (mantendo funcionalidade original)
        function fillTableVendedor(vendedorStats) {
            const tbody = document.querySelector('#tableVendedor tbody');
            tbody.innerHTML = '';
            
            const sortedVendedores = Array.from(vendedorStats.entries()).sort((a, b) => b[1].sum - a[1].sum);
            
            sortedVendedores.forEach(([vendedor, stats]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vendedor}</td>
                    <td>${stats.count}</td>
                    <td>${formatCurrency(stats.sum)}</td>
                `;
                tbody.appendChild(row);
            });
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'table-total';
            const totalTitulos = Array.from(vendedorStats.values()).reduce((sum, stats) => sum + stats.count, 0);
            const totalValor = Array.from(vendedorStats.values()).reduce((sum, stats) => sum + stats.sum, 0);
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td><strong>${totalTitulos}</strong></td>
                <td><strong>${formatCurrency(totalValor)}</strong></td>
            `;
            tbody.appendChild(totalRow);
        }

        function fillTableClienteVendedor(clienteVendedorStats, empresaStats) {
            const tbody = document.querySelector('#tableClienteVendedor tbody');
            tbody.innerHTML = '';
            
            const sortedClienteVendedor = Array.from(clienteVendedorStats.values()).sort((a, b) => b.sum - a.sum);
            
            sortedClienteVendedor.forEach(stats => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stats.cliente}</td>
                    <td>${stats.vendedor}</td>
                    <td>${stats.count}</td>
                    <td>${formatCurrency(stats.sum)}</td>
                `;
                tbody.appendChild(row);
            });
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'table-total';
            const totalTitulos = sortedClienteVendedor.reduce((sum, stats) => sum + stats.count, 0);
            const totalValor = sortedClienteVendedor.reduce((sum, stats) => sum + stats.sum, 0);
            totalRow.innerHTML = `
                <td colspan="2"><strong>TOTAL</strong></td>
                <td><strong>${totalTitulos}</strong></td>
                <td><strong>${formatCurrency(totalValor)}</strong></td>
            `;
            tbody.appendChild(totalRow);
        }

        function fillMesSubcards(mesStats) {
            mesSubcards.innerHTML = '';
            
            const sortedMeses = Array.from(mesStats.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            
            sortedMeses.forEach(([mes, stats]) => {
                const [ano, mesNum] = mes.split('-');
                const mesNome = new Date(ano, mesNum - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                const subcard = document.createElement('div');
                subcard.className = 'subcard';
                subcard.innerHTML = `
                    <div class="subcard-header">${mesNome}</div>
                    <div class="subcard-body">
                        <p><strong>T√≠tulos:</strong> ${stats.count}</p>
                        <p><strong>Valor Total:</strong> ${formatCurrency(stats.sum)}</p>
                        <p><strong>Valor M√©dio:</strong> ${formatCurrency(stats.sum / stats.count)}</p>
                    </div>
                `;
                mesSubcards.appendChild(subcard);
            });
        }

        function fillVendedorMesSubcards(pivotVendedorMes, pivotSemVendedorMes, mesesSet) {
            vendedorMesSubcards.innerHTML = '';
            
            // Subcard para vendedores espec√≠ficos
            pivotVendedorMes.forEach((mesData, vendedor) => {
                const subcard = document.createElement('div');
                subcard.className = 'subcard';
                
                let tableContent = '<table class="subcard-table"><thead><tr><th>M√™s</th><th>Valor</th></tr></thead><tbody>';
                
                const sortedMeses = Array.from(mesData.entries()).sort((a, b) => a[0].localeCompare(b[0]));
                let totalVendedor = 0;
                
                sortedMeses.forEach(([mes, valor]) => {
                    const [ano, mesNum] = mes.split('-');
                    const mesNome = new Date(ano, mesNum - 1, 1).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                    tableContent += `<tr><td>${mesNome}</td><td>${formatCurrency(valor)}</td></tr>`;
                    totalVendedor += valor;
                });
                
                tableContent += `<tr class="table-total"><td><strong>TOTAL</strong></td><td><strong>${formatCurrency(totalVendedor)}</strong></td></tr>`;
                tableContent += '</tbody></table>';
                
                subcard.innerHTML = `
                    <div class="subcard-header">üë§ ${vendedor}</div>
                    <div class="subcard-body">${tableContent}</div>
                `;
                vendedorMesSubcards.appendChild(subcard);
            });
            
            // Subcard para "Sem Vendedor"
            if (pivotSemVendedorMes.size > 0) {
                const subcard = document.createElement('div');
                subcard.className = 'subcard';
                
                let tableContent = '<table class="subcard-table"><thead><tr><th>M√™s</th><th>Valor</th></tr></thead><tbody>';
                
                const sortedMeses = Array.from(pivotSemVendedorMes.entries()).sort((a, b) => a[0].localeCompare(b[0]));
                let totalSemVendedor = 0;
                
                sortedMeses.forEach(([mes, valor]) => {
                    const [ano, mesNum] = mes.split('-');
                    const mesNome = new Date(ano, mesNum - 1, 1).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                    tableContent += `<tr><td>${mesNome}</td><td>${formatCurrency(valor)}</td></tr>`;
                    totalSemVendedor += valor;
                });
                
                tableContent += `<tr class="table-total"><td><strong>TOTAL</strong></td><td><strong>${formatCurrency(totalSemVendedor)}</strong></td></tr>`;
                tableContent += '</tbody></table>';
                
                subcard.innerHTML = `
                    <div class="subcard-header">‚ùì Sem Vendedor</div>
                    <div class="subcard-body">${tableContent}</div>
                `;
                vendedorMesSubcards.appendChild(subcard);
            }
        }

        function fillFutureSubcards(futureData, limitDateFormatted) {
            futureSubcards.innerHTML = '';
            
            if (futureData.length === 0) {
                futureSubcards.innerHTML = '<div class="text-center py-4"><h5>‚úÖ Nenhum t√≠tulo com vencimento futuro encontrado</h5></div>';
                return;
            }
            
            // Agrupar por m√™s
            const futureByMonth = new Map();
            futureData.forEach(item => {
                const mes = item.vencimento.getFullYear() + '-' + String(item.vencimento.getMonth() + 1).padStart(2, '0');
                if (!futureByMonth.has(mes)) {
                    futureByMonth.set(mes, []);
                }
                futureByMonth.get(mes).push(item);
                });
            
            const sortedFutureMeses = Array.from(futureByMonth.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            
            sortedFutureMeses.forEach(([mes, items]) => {
                const [ano, mesNum] = mes.split('-');
                const mesNome = new Date(ano, mesNum - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                const subcard = document.createElement('div');
                subcard.className = 'subcard';
                
                // CORRE√á√ÉO: Adicionar coluna da empresa emissora e remover informa√ß√µes incompreens√≠veis
                let tableContent = '<table class="subcard-table"><thead><tr><th>Cliente</th><th>Vencimento</th><th>Valor</th><th>Vendedor</th><th>Empresa Emissora</th></tr></thead><tbody>';
                
                let totalMes = 0;
                items.sort((a, b) => a.vencimento - b.vencimento).forEach(item => {
                    tableContent += `
                        <tr>
                            <td>${item.cliente}</td>
                            <td>${item.vencimento.toLocaleDateString('pt-BR')}</td>
                            <td>${formatCurrency(item.valor)}</td>
                            <td>${item.vendedor || 'Sem Vendedor'}</td>
                            <td>${item.empresaEmissora || 'N√£o Informado'}</td>
                        </tr>
                    `;
                    totalMes += item.valor;
                });
                
                tableContent += `<tr class="table-total"><td colspan="2"><strong>TOTAL (${items.length} t√≠tulos)</strong></td><td><strong>${formatCurrency(totalMes)}</strong></td><td colspan="2"></td></tr>`;
                tableContent += '</tbody></table>';
                
                subcard.innerHTML = `
                    <div class="subcard-header">üìÖ ${mesNome} (Futuro)</div>
                    <div class="subcard-body">${tableContent}</div>
                `;
                futureSubcards.appendChild(subcard);
            });
        }

        // Fun√ß√£o para gerar PDF geral - CORRIGIDA para informa√ß√µes mais claras
        function generatePdf(download = true) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');
                let yPosition = 20;
                
                // T√≠tulo
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                const titulo = dashboardTitle.textContent;
                doc.text(titulo, 20, yPosition);
                yPosition += 15;
                
                // Resumo Geral - CORRE√á√ÉO: Informa√ß√µes mais claras
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Resumo Geral', 20, yPosition);
                yPosition += 10;
                
                const resumoItems = document.querySelectorAll('#resumoGrid .resumo-item:not(.insights-global)');
                resumoItems.forEach((item, index) => {
                    const label = item.querySelector('.resumo-label').textContent;
                    const value = item.querySelector('.resumo-value').textContent;
                    
                    const x = 20 + (index % 3) * 90;
                    const y = yPosition + Math.floor(index / 3) * 15;
                    
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(label + ':', x, y);
                    doc.setFont(undefined, 'bold');
                    doc.text(value, x, y + 5);
                });
                
                yPosition += Math.ceil(resumoItems.length / 3) * 15 + 10;
                
                // Empresas section if present
                const empresasItems = document.querySelectorAll('#empresasGrid .resumo-empresa-item');
                if (empresasItems.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Distribui√ß√£o por Empresa Emissora', 20, yPosition);
                    yPosition += 10;

                    empresasItems.forEach((item, index) => {
                        const label = item.querySelector('.resumo-empresa-label').textContent;
                        const value = item.querySelector('.resumo-empresa-value').textContent;
                        const count = item.querySelector('div[style*="font-size: 0.8rem"]').textContent;

                        const x = 20 + (index % 3) * 90;
                        const y = yPosition + Math.floor(index / 3) * 20;

                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        doc.text(label + ':', x, y);
                        doc.setFont(undefined, 'bold');
                        doc.text(value, x, y + 5);
                        doc.setFont(undefined, 'normal');
                        doc.text(count, x, y + 10);
                    });

                    yPosition += Math.ceil(empresasItems.length / 3) * 20 + 10;
                }

                // Months section
                const monthsItems = document.querySelectorAll('#monthsGrid .resumo-empresa-item');
                if (monthsItems.length > 0) {
                    if (yPosition > 150) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Distribui√ß√£o por M√™s Selecionado', 20, yPosition);
                    yPosition += 10;

                    monthsItems.forEach((item, index) => {
                        const label = item.querySelector('.resumo-empresa-label').textContent;
                        const value = item.querySelector('.resumo-empresa-value').textContent;
                        const count = item.querySelector('div[style*="font-size: 0.8rem"]').textContent;

                        const x = 20 + (index % 3) * 90;
                        const y = yPosition + Math.floor(index / 3) * 20;

                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        doc.text(label + ':', x, y);
                        doc.setFont(undefined, 'bold');
                        doc.text(value, x, y + 5);
                        doc.setFont(undefined, 'normal');
                        doc.text(count, x, y + 10);
                    });

                    yPosition += Math.ceil(monthsItems.length / 3) * 20 + 10;
                }

                // Insights
                const insights = document.querySelectorAll('.insight-item');
                if (insights.length > 0) {
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Insights Globais', 20, yPosition);
                    yPosition += 10;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    insights.forEach(insight => {
                        const line = insight.querySelector('.insight-value').textContent;
                        doc.text(line, 20, yPosition);
                        yPosition += 7;
                    });
                    yPosition += 5;
                }

                // Tabelas
                const tables = [
                    { id: 'tableCliente', title: 'Volume de T√≠tulos por Cliente' },
                    { id: 'tableVendedor', title: 'Volume de T√≠tulos por Vendedor' },
                    { id: 'tableClienteVendedor', title: 'Volume de T√≠tulos por Cliente e Vendedor' }
                ];
                
                tables.forEach(tableInfo => {
                    const table = document.getElementById(tableInfo.id);
                    if (table && table.querySelector('tbody').children.length > 0) {
                        // Verificar se precisa de nova p√°gina
                        if (yPosition > 150) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(tableInfo.title, 20, yPosition);
                        yPosition += 10;
                        
                        // Extrair dados da tabela - MELHORIA: remover coluna de a√ß√µes
                        const headers = Array.from(table.querySelectorAll('thead th'))
                            .map(th => th.textContent)
                            .filter(header => header !== 'A√ß√µes'); // Remover coluna de a√ß√µes
                        
                        const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
                            const cells = Array.from(tr.querySelectorAll('td'));
                            // Filtrar c√©lulas que n√£o s√£o da coluna de a√ß√µes
                            return cells
                                .filter((cell, index) => {
                                    const header = table.querySelectorAll('thead th')[index].textContent;
                                    return header !== 'A√ß√µes';
                                })
                                .map(td => td.textContent.replace('üìä Ver Hist√≥rico', '').trim());
                        });
                        
                        doc.autoTable({
                            startY: yPosition,
                            head: [headers],
                            body: rows,
                            theme: 'grid',
                            styles: { fontSize: 8 },
                            headStyles: { fillColor: [0, 123, 255] },
                            // MELHORIA: Distribui√ß√£o autom√°tica de colunas
                            columnStyles: {
                                0: { cellWidth: 'auto' },
                                1: { cellWidth: 'auto' },
                                2: { cellWidth: 'auto' }
                            },
                            margin: { left: 10, right: 10 }
                        });
                        
                        yPosition = doc.lastAutoTable.finalY + 15;
                    }
                });
                
                // Subcards
                const subcardContainers = [
                    { element: mesSubcards, title: 'Volume por M√™s' },
                    { element: vendedorMesSubcards, title: 'Distribui√ß√£o por Vendedor e M√™s' },
                    { element: futureSubcards, title: 'T√≠tulos com Vencimento Futuro' }
                ];
                
                subcardContainers.forEach(containerInfo => {
                    const subcards = containerInfo.element.querySelectorAll('.subcard');
                    if (subcards.length > 0) {
                        doc.addPage();
                        yPosition = 20;
                        
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(containerInfo.title, 20, yPosition);
                        yPosition += 15;
                        
                        subcards.forEach(subcard => {
                            const header = subcard.querySelector('.subcard-header').textContent;
                            const table = subcard.querySelector('.subcard-table');
                            
                            if (table) {
                                if (yPosition > 180) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                
                                doc.setFontSize(10);
                                doc.setFont(undefined, 'bold');
                                doc.text(header, 20, yPosition);
                                yPosition += 8;
                                
                                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                                const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => 
                                    Array.from(tr.querySelectorAll('td')).map(td => td.textContent)
                                );
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [headers],
                                    body: rows,
                                    theme: 'grid',
                                    styles: { fontSize: 7 },
                                    headStyles: { fillColor: [108, 117, 125] },
                                    // MELHORIA: Distribui√ß√£o autom√°tica de colunas para subcards
                                    columnStyles: {
                                        0: { cellWidth: 'auto' },
                                        1: { cellWidth: 'auto' },
                                        2: { cellWidth: 'auto' },
                                        3: { cellWidth: 'auto' }
                                    },
                                    margin: { left: 10, right: 10 }
                                });
                                
                                yPosition = doc.lastAutoTable.finalY + 10;
                            }
                        });
                    }
                });
                
                if (download) {
                    const fileName = `Dashboard_Inadimplencia_${new Date().toISOString().slice(0, 10)}.pdf`;
                    doc.save(fileName);
                } else {
                    const pdfBlob = doc.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    window.open(pdfUrl, '_blank');
                }
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Verifique o console para mais detalhes.');
            }
        }
    </script>
</body>
</html>